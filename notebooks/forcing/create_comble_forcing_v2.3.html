
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>DEPHY Forcing Derivation &#8212; COMBLE Model-Observation Intercomparison Project</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js?v=4a39c7ea"></script>
    <script async="async" kind="hypothesis" src="https://hypothes.is/embed.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'notebooks/forcing/create_comble_forcing_v2.3';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../../README.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../_static/arm_logo.png" class="logo__image only-light" alt="COMBLE Model-Observation Intercomparison Project - Home"/>
    <script>document.write(`<img src="../../_static/arm_logo.png" class="logo__image only-dark" alt="COMBLE Model-Observation Intercomparison Project - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../README.html">
                    COMBLE Model-Observation Intercomparison Project Cookbook
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Project Information</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../goals_hypotheses.html">Goals and Hypotheses</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Participants</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../participants/participants_list.html">List of Planned Participants</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">How-To</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../howto/workbench_instructions.html">Apply for Elevated JupyterHub Access</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../CONTRIBUTING.html">Contributers Guide</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Model Settings &amp; Logistics</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../main_configuration.html">Main Model Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../output/output_list.html">Requested Model Outputs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../timeline.html">Timeline &amp; File Naming Convention</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Input Conversion Notebooks</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../conversion/convert_comble_dephy_forcing_to_DHARMA_LES_and_ModelE3_SCM_forcing.html">Example: convert DEPHY forcing to DHARMA LES and ModelE3 SCM formats</a></li>
<li class="toctree-l1"><a class="reference internal" href="../conversion/convert_comble_dephy_forcing_to_UCLALES-SALSA_forcing.html">Convert DEPHY forcing to UCLALES-SALSA forcing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../conversion/convert_comble_dephy_forcing_to_WRF_LES_forcing.html">Example: convert DEPHY forcing to WRF-LES forcing</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Output Conversion Notebooks</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../conversion_output/convert_AOSCM_output_to_dephy_format.html">Example: convert AOSCM output to DEPHY format</a></li>
<li class="toctree-l1"><a class="reference internal" href="../conversion_output/convert_DHARMA_LES_output_to_dephy_format.html">Example: convert DHARMA LES output to DEPHY format</a></li>
<li class="toctree-l1"><a class="reference internal" href="../conversion_output/convert_DHARMA_LES_output_to_dephy_format_2D.html">Example: convert DHARMA LES 2D output to DEPHY format</a></li>
<li class="toctree-l1"><a class="reference internal" href="../conversion_output/convert_DHARMA_LES_output_to_dephy_format_3D.html">Example: convert DHARMA LES 3D output to DEPHY format</a></li>
<li class="toctree-l1"><a class="reference internal" href="../conversion_output/convert_E3SMv2_SCM_output_to_dephy_format.html">Example: convert E3SMv2 SCM output to DEPHY format</a></li>
<li class="toctree-l1"><a class="reference internal" href="../conversion_output/convert_E3SMv3_SCM_output_to_dephy_format.html">Example: convert E3SMv3 SCM output to DEPHY format</a></li>
<li class="toctree-l1"><a class="reference internal" href="../conversion_output/convert_ICON_SCM_output_to_dephy_format.html">convert ICON SCM output to DEPHY format</a></li>
<li class="toctree-l1"><a class="reference internal" href="../conversion_output/convert_ModelE3_SCM_output_to_dephy_format.html">Example: convert ModelE3 SCM output to DEPHY format</a></li>
<li class="toctree-l1"><a class="reference internal" href="../conversion_output/convert_UCLALES-SALSA_output_to_dephy_format.html">Convert UCLALES-SALSA output to DEPHY format</a></li>
<li class="toctree-l1"><a class="reference internal" href="../conversion_output/convert_WRF_LES_output_to_dephy_format.html">Example: convert WRF-LES output to DEPHY format</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Plotting and Analysis</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../les_plotting_index.html">LES</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../plotting/plot_les_FixN_noice.html">Compare FixN_noice LES Sims</a></li>
<li class="toctree-l2"><a class="reference internal" href="../plotting/plot_les_FixN.html">Compare FixN LES Sims</a></li>
<li class="toctree-l2"><a class="reference internal" href="../plotting/plot_les_FixN_def_z0.html">Compare FixN_def_z0 LES Sims</a></li>
<li class="toctree-l2"><a class="reference internal" href="../plotting/plot_les_ProgNa.html">Compare ProgNa LES Sims</a></li>
<li class="toctree-l2"><a class="reference internal" href="../plotting/plot_les_ProgNaNi.html">Compare ProgNaNi LES Sims</a></li>
<li class="toctree-l2"><a class="reference internal" href="../plotting/example_plotting.html">Evaluation of LES against satellite and ground-based observations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../plotting/example_plotting_progna.html">Evaluation of LES against satellite and ground-based observations (ProgNa)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../plotting/example_plotting_prognani.html">Evaluation of LES against satellite and ground-based observations (ProgNaNi)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../plotting/example_plotting_2D.html">2D plotting of LES output</a></li>
<li class="toctree-l2"><a class="reference internal" href="../plotting/check_les_2D.html">Check my LES run - 2D output</a></li>
<li class="toctree-l2"><a class="reference internal" href="../plotting/check_les_3D.html">Check my LES run - 3D output</a></li>
<li class="toctree-l2"><a class="reference internal" href="../plotting/example_plotting_2D_cluster.html">2D plotting of LES output vs. satellite imagery (work in progress)</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../scm_plotting_index.html">SCM</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../plotting/check_scm.html">Check my SCM run</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../les_scm_plotting_index.html">LES &amp; SCM</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../plotting/plot_FixN.html">Check ModelE output against LES for the “FixN” configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../plotting/plot_FixN-allSCM.html">Check all SCMs against LES for the “FixN” configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../plotting/plot_FixN_noice.html">Check ModelE against LES for the “FixN_noice” configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../plotting/plot_FixN_noice-allSCM.html">Check all SCMs against LES for the “FixN_noice” configuration</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="../../emc2.html">The Earth Model Column Collaboratory (EMC<sup>2</sup>)</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Supporting Materials</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="create_comble_forcing_v2.4.html">DEPHY Forcing Derivation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../plotting/example_plotting_specification_tests.html">Sensitivity to solar radiation, subsidence and treatment of ice surface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../plotting/example_plotting_z0_tests.html">Sensitivity to roughness lengths</a></li>
<li class="toctree-l1"><a class="reference internal" href="../setup/aerosol-specification.html">Aerosol specification</a></li>
<li class="toctree-l1"><a class="reference internal" href="../setup/aerosol-inp-closure.html">Aerosol-Ice Nucleating Particle Closure</a></li>
<li class="toctree-l1"><a class="reference internal" href="../setup/aerosol-surface.html">Specifying Surface Aerosol Emissions for Simulations with Multi-Modal Aerosol</a></li>

<li class="toctree-l1"><a class="reference internal" href="../setup/where-are-the-rolls.html">Where are the rolls?</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://jupyterhub.arm.gov/hub/user-redirect/git-pull?repo=https%3A//github.com/ARM-Development/comble-mip&urlpath=lab/tree/comble-mip/../user-data-home/comble-mip/notebooks/forcing/create_comble_forcing_v2.3.ipynb&branch=main" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch on JupyterHub"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img alt="JupyterHub logo" src="../../_static/images/logo_jupyterhub.svg">
  </span>
<span class="btn__text-container">JupyterHub</span>
</a>
</li>
      
  </ul>
</div>



<a href="https://github.com/ARM-Development/comble-mip" target="_blank"
   class="btn btn-sm btn-source-repository-button"
   title="Source repository"
   data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>

</a>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/notebooks/forcing/create_comble_forcing_v2.3.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>DEPHY Forcing Derivation</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#import-libraries">Import libraries</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#user-mods">User mods</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#set-things-for-future-calculations">Set things for future calculations</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#create-vertical-grid">Create vertical grid</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#read-in-data-from-era5-backtrajectory-netcdf">Read in data from ERA5 backtrajectory (netCDF)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#get-geostrophic-wind-forcing">Get Geostrophic wind forcing</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#interpolate-profiles">Interpolate profiles</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#smooth-initial-water-vapor-mixing-ratio-profile">Smooth initial water vapor mixing ratio profile</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#do-surface-forcing">Do surface forcing</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#create-new-netcdf-file">Create new netcdf file</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="dephy-forcing-derivation">
<h1>DEPHY Forcing Derivation<a class="headerlink" href="#dephy-forcing-derivation" title="Link to this heading">#</a></h1>
<ul class="simple">
<li><p>Developed by Tim Juliano (NCAR-RAL), Ann Fridlind (NASA-GISS), and Florian Tornow (NASA-GISS/Columbia Univ.) with substantial contributions by Peng Wu (PNNL), Gunilla Svensson (Stockholm Univ.), and Andy Ackerman (NASA-GISS)</p></li>
<li><p>v2.3 created on 11/17/23, updated 12/1/23</p></li>
<li><p>Based on ERA5 backward trajectory, beginning at Andenes, Norway (03/13/20 at 18 UTC)</p></li>
<li><p>We have the option of starting as far as 28 hours before arriving at Andenes (03/12/20 at 14 UTC)</p></li>
</ul>
<section id="import-libraries">
<h2>Import libraries<a class="headerlink" href="#import-libraries" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy.ma</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">ma</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">netCDF4</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dataset</span><span class="p">,</span> <span class="n">date2num</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">dt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy</span><span class="w"> </span><span class="kn">import</span> <span class="n">interpolate</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">geopy.distance</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.ndimage</span><span class="w"> </span><span class="kn">import</span> <span class="n">gaussian_filter1d</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="user-mods">
<h2>User mods<a class="headerlink" href="#user-mods" title="Link to this heading">#</a></h2>
<ol class="arabic simple">
<li><p>How many hours before ice edge do you want to start?</p></li>
</ol>
<ul class="simple">
<li><p>Note: Value == 0 means you are starting approx. at ice edge, Value == 10 means you are starting 10 h upstream (north) of the ice edge</p></li>
<li><p>Note: Value must be an integer</p></li>
<li><p>Note: t0_h represents simulation start time, t0_h_init_th_qv represents initial theta/qv profile to use; set equivalent if everything should be initialized using information at same time</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">t0_h</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">t0_h_init_th_qv</span> <span class="o">=</span> <span class="mi">5</span>
<span class="k">if</span> <span class="n">t0_h</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">t0_h</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Error: Please set 0 &lt;= t0_h &gt;= 10&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<ol class="arabic simple" start="2">
<li><p>Clobber old forcing file?</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">clobber_old_file</span> <span class="o">=</span> <span class="kc">True</span>
</pre></div>
</div>
</div>
</div>
<ol class="arabic simple" start="3">
<li><p>Forcing file save name</p></li>
</ol>
<ul class="simple">
<li><p>Note: For this and all file paths, include directory in the name</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">save_name</span> <span class="o">=</span> <span class="s1">&#39;COMBLE_INTERCOMPARISON_FORCING_V2.3.nc&#39;</span>
</pre></div>
</div>
</div>
</div>
<ol class="arabic simple" start="4">
<li><p>Name of current script for global attribute</p></li>
</ol>
<ul class="simple">
<li><p>Note: Can use ipynbname library to automatically generate script name, but this is not a standard library so skipping for now</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">script_name</span> <span class="o">=</span> <span class="s1">&#39;create_comble_forcing_v2.3.ipynb&#39;</span>
</pre></div>
</div>
</div>
</div>
<ol class="arabic simple" start="5">
<li><p>LES domain locations</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fname_les_domain</span> <span class="o">=</span> <span class="s1">&#39;LES_domain_location_28h_18Z_Mar13_2020.txt&#39;</span>
</pre></div>
</div>
</div>
</div>
<ol class="arabic simple" start="6">
<li><p>ERA5 backward trajectory met file name</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fname_era5_met</span> <span class="o">=</span> <span class="s1">&#39;theta_temp_rh_sh_uvw_sst_along_trajectory_era5ml_28h_end_2020-03-13-18_v2.nc&#39;</span>
</pre></div>
</div>
</div>
</div>
<ol class="arabic simple" start="7">
<li><p>ERA5 backward trajectory ozone file name</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fname_era5_o3</span> <span class="o">=</span> <span class="s1">&#39;ERA5_forcing_along_trajectory_end_2020-03-13-18.nc&#39;</span>
</pre></div>
</div>
</div>
</div>
<ol class="arabic simple" start="8">
<li><p>1D model profiles file name</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">profiles_1d_model</span> <span class="o">=</span> <span class="s1">&#39;u_v_theta_z.txt&#39;</span>
</pre></div>
</div>
</div>
</div>
<ol class="arabic simple" start="9">
<li><p>Sea ice concentration file name</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fname_sic</span> <span class="o">=</span> <span class="s1">&#39;Svalbard_asi-AMSR2-n10m-20200313_m.nc&#39;</span>
</pre></div>
</div>
</div>
</div>
<ol class="arabic simple" start="10">
<li><p>Do geostrophic wind calc and add to forcing file? If so, supply ERA5 geopotential height file name and minimum grid spacing (km) for discretization</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">do_geo</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">if</span> <span class="n">do_geo</span><span class="p">:</span>
    <span class="n">fname_era5_geo</span> <span class="o">=</span> <span class="s1">&#39;/glade/scratch/tjuliano/doe_comble/wrf_asr_cao/WRF-ASR-CAO/scripts/era5/era5_mar13_case_larger.nc&#39;</span>
    <span class="n">min_dx</span> <span class="o">=</span> <span class="mf">20.</span>
    <span class="n">min_dy</span> <span class="o">=</span> <span class="mf">20.</span>
</pre></div>
</div>
</div>
</div>
<ol class="arabic simple" start="11">
<li><p>Add theta and qv nudging, as well as subsidence, to forcing file?</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">do_u_v_nudge</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">do_th_qv_nudge</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">do_subsidence</span> <span class="o">=</span> <span class="kc">True</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="set-things-for-future-calculations">
<h2>Set things for future calculations<a class="headerlink" href="#set-things-for-future-calculations" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>Note: no need for user to modify these, computed automatically</p></li>
</ul>
<ul class="simple">
<li><p>Timings</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nhrs</span> <span class="o">=</span> <span class="mi">18</span> <span class="o">+</span> <span class="n">t0_h</span> <span class="o">+</span> <span class="mi">1</span> <span class="c1"># total number of simulation hours, including t0</span>
<span class="k">if</span> <span class="n">t0_h</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="s1">&#39;2020-03-13 00:00:00&#39;</span>
    <span class="n">start_day</span> <span class="o">=</span> <span class="mi">13</span>
    <span class="n">start_hour</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="s1">&#39;2020-03-12 &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="mi">24</span><span class="o">-</span><span class="n">t0_h</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;:00:00&#39;</span>
    <span class="n">start_day</span> <span class="o">=</span> <span class="mi">12</span>
    <span class="n">start_hour</span> <span class="o">=</span> <span class="mi">24</span><span class="o">-</span><span class="n">t0_h</span>
<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;Start time is: &#39;</span> <span class="o">+</span> <span class="n">start_time</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Start time is: 2020-03-12 22:00:00
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Constants for geostrophic wind calc</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">do_geo</span><span class="p">:</span>
    <span class="n">omega</span> <span class="o">=</span> <span class="mf">7.2921e-5</span> <span class="c1"># angular velocity</span>
    <span class="n">g</span> <span class="o">=</span> <span class="mf">9.81</span> <span class="c1"># grav constant</span>
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Delete forcing file if already exists</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">clobber_old_file</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">save_name</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">save_name</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;The file &#39;</span> <span class="o">+</span> <span class="n">save_name</span> <span class="o">+</span> <span class="s1">&#39; has been deleted successfully&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>The file COMBLE_INTERCOMPARISON_FORCING_V2.3.nc has been deleted successfully
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Get LES domain locations</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">les_loc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">fname_les_domain</span><span class="p">,</span><span class="n">skiprows</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">les_hh</span> <span class="o">=</span> <span class="n">les_loc</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
<span class="n">les_hh_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">les_hh</span><span class="o">&gt;=-</span><span class="mf">1.</span><span class="o">*</span><span class="n">t0_h</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">les_lat</span> <span class="o">=</span> <span class="n">les_loc</span><span class="p">[</span><span class="n">les_hh_idx</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
<span class="n">les_lat2</span> <span class="o">=</span> <span class="n">les_lat</span><span class="p">[::</span><span class="mi">12</span><span class="p">]</span>
<span class="n">les_lon</span> <span class="o">=</span> <span class="n">les_loc</span><span class="p">[</span><span class="n">les_hh_idx</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>
<span class="n">les_lon2</span> <span class="o">=</span> <span class="n">les_lon</span><span class="p">[::</span><span class="mi">12</span><span class="p">]</span>

<span class="n">les_lat_mid</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">les_lat</span><span class="p">),</span><span class="mi">1</span><span class="p">)</span>
<span class="n">les_lon_mid</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">les_lon</span><span class="p">),</span><span class="mi">1</span><span class="p">)</span>
<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;LES domain mid point: &#39;</span> <span class="o">+</span> <span class="s1">&#39;lat=&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">les_lat_mid</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;N, lon=&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">les_lon_mid</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;E&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>LES domain mid point: lat=74.5N, lon=9.9E
</pre></div>
</div>
</div>
</div>
</section>
<section id="create-vertical-grid">
<h2>Create vertical grid<a class="headerlink" href="#create-vertical-grid" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>160 vertical grid levels, defined at the cell faces</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nz</span> <span class="o">=</span> <span class="mi">160</span>

<span class="n">dz_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">nz</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">dz_grid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">20.0</span>
<span class="n">dz_grid</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">25.0</span>
<span class="n">dz_grid</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mf">30.0</span>
<span class="n">dz_grid</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mf">35.0</span>
<span class="n">dz_grid</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">140</span><span class="p">]</span> <span class="o">=</span> <span class="mf">40.0</span>
<span class="n">dz_grid</span><span class="p">[</span><span class="mi">140</span><span class="p">]</span> <span class="o">=</span> <span class="mf">60.0</span>
<span class="n">dz_grid</span><span class="p">[</span><span class="mi">141</span><span class="p">:</span><span class="mi">157</span><span class="p">]</span> <span class="o">=</span> <span class="mf">80.0</span>
<span class="n">dz_grid</span><span class="p">[</span><span class="mi">157</span><span class="p">]</span> <span class="o">=</span> <span class="mf">60.0</span>
<span class="n">dz_grid</span><span class="p">[</span><span class="mi">158</span><span class="p">]</span> <span class="o">=</span> <span class="mf">50.0</span>

<span class="n">z_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">nz</span><span class="p">)</span>
<span class="n">z_grid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">z_grid</span><span class="p">)):</span>
    <span class="n">z_grid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">z_grid</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">dz_grid</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="read-in-data-from-era5-backtrajectory-netcdf">
<h2>Read in data from ERA5 backtrajectory (netCDF)<a class="headerlink" href="#read-in-data-from-era5-backtrajectory-netcdf" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Open met dataset</span>
<span class="n">dataset</span> <span class="o">=</span> <span class="n">Dataset</span><span class="p">(</span><span class="n">fname_era5_met</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span>

<span class="c1"># Read variables (1D arrays are time, 2D arrays are time x pressure level)</span>
<span class="n">hours</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;Time&#39;</span><span class="p">][:]</span>
<span class="n">lat</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;Latitude&#39;</span><span class="p">][:]</span>
<span class="n">lon</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;Longitude&#39;</span><span class="p">][:]</span>
<span class="n">pres</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;Pressure&#39;</span><span class="p">][:,:]</span>
<span class="n">sfc_pres</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;SfcPres&#39;</span><span class="p">][:]</span>
<span class="n">sst</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;SST&#39;</span><span class="p">][:]</span>
<span class="n">hgt</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;GEOS_HT&#39;</span><span class="p">][:,:]</span>
<span class="n">uwnd</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;U&#39;</span><span class="p">][:,:]</span>
<span class="n">vwnd</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;V&#39;</span><span class="p">][:,:]</span>
<span class="n">wwnd</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;W&#39;</span><span class="p">][:,:]</span>
<span class="n">temp</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;Temp&#39;</span><span class="p">][:,:]</span>
<span class="n">theta</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;Theta&#39;</span><span class="p">][:,:]</span>
<span class="n">qv</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;SH&#39;</span><span class="p">][:,:]</span>

<span class="c1"># Open ozone dataset</span>
<span class="n">dataset_o3</span> <span class="o">=</span> <span class="n">Dataset</span><span class="p">(</span><span class="n">fname_era5_o3</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span>

<span class="c1"># Read variables</span>
<span class="n">o3</span> <span class="o">=</span> <span class="n">dataset_o3</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;O3&#39;</span><span class="p">][:,:]</span>
<span class="n">pres_o3</span> <span class="o">=</span> <span class="n">dataset_o3</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;Pressure&#39;</span><span class="p">][:]</span>
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Convert units</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pres_pa</span> <span class="o">=</span> <span class="n">pres</span><span class="o">*</span><span class="mf">100.</span>          <span class="c1"># hPa to Pa</span>
<span class="n">pres_o3_pa</span> <span class="o">=</span> <span class="n">pres_o3</span><span class="o">*</span><span class="mf">100.</span>    <span class="c1"># hPa to Pa</span>
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Reverse time dimension of 2D arrays, as well as sfc pressure and sst, so that beginning of backward trajectory is in first position</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hgt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">hgt</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">uwnd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">uwnd</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">vwnd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">vwnd</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">wwnd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">wwnd</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">pres_pa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">pres_pa</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">qv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">qv</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">o3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">o3</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">sfc_pres</span> <span class="o">=</span> <span class="n">sfc_pres</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">sst</span> <span class="o">=</span> <span class="n">sst</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Unmask sst field and get index according to t0_h (furthest north we can go is 28h after backtrajectory initialization from Andenes, or 3/12/20 at 14 UTC)</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sst_real</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">sst</span><span class="p">)</span>
<span class="n">loopidx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">sst_real</span><span class="o">&gt;</span><span class="mf">0.0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">t0</span> <span class="o">=</span> <span class="n">loopidx</span><span class="p">[</span><span class="mi">10</span><span class="o">-</span><span class="n">t0_h</span><span class="p">]</span>
<span class="n">t0_init_th_qv</span> <span class="o">=</span> <span class="n">loopidx</span><span class="p">[</span><span class="mi">10</span><span class="o">-</span><span class="n">t0_h_init_th_qv</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Calculate sfc potential temperature</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">theta1000mb</span> <span class="o">=</span> <span class="n">theta</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
<span class="n">sfc_theta</span> <span class="o">=</span> <span class="n">theta1000mb</span><span class="o">*</span><span class="nb">pow</span><span class="p">((</span><span class="mf">100000.</span><span class="o">/</span><span class="n">sfc_pres</span><span class="p">),</span><span class="mf">0.286</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Get information at t0</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">z1</span> <span class="o">=</span> <span class="mi">0</span>

<span class="n">pres_t0</span> <span class="o">=</span> <span class="n">pres_pa</span><span class="p">[</span><span class="n">t0</span><span class="p">,</span><span class="n">z1</span><span class="p">:]</span>
<span class="n">pres_o3_t0</span> <span class="o">=</span> <span class="n">pres_o3_pa</span><span class="p">[</span><span class="n">z1</span><span class="p">:]</span>
<span class="n">hgt_t0</span> <span class="o">=</span> <span class="n">hgt</span><span class="p">[</span><span class="n">t0_init_th_qv</span><span class="p">,</span><span class="n">z1</span><span class="p">:]</span>
<span class="n">uwnd_t0</span> <span class="o">=</span> <span class="n">uwnd</span><span class="p">[</span><span class="n">t0</span><span class="p">,</span><span class="n">z1</span><span class="p">:]</span>
<span class="n">vwnd_t0</span> <span class="o">=</span> <span class="n">vwnd</span><span class="p">[</span><span class="n">t0</span><span class="p">,</span><span class="n">z1</span><span class="p">:]</span>
<span class="n">wwnd_t0</span> <span class="o">=</span> <span class="n">wwnd</span><span class="p">[</span><span class="n">t0</span><span class="p">,</span><span class="n">z1</span><span class="p">:]</span>
<span class="n">temp_t0</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[</span><span class="n">t0_init_th_qv</span><span class="p">,</span><span class="n">z1</span><span class="p">:]</span>
<span class="n">theta_t0</span> <span class="o">=</span> <span class="n">theta</span><span class="p">[</span><span class="n">t0_init_th_qv</span><span class="p">,</span><span class="n">z1</span><span class="p">:]</span>
<span class="n">qv_t0</span> <span class="o">=</span> <span class="n">qv</span><span class="p">[</span><span class="n">t0_init_th_qv</span><span class="p">,</span><span class="n">z1</span><span class="p">:]</span>

<span class="c1"># temporal avg for o3</span>
<span class="n">o3_t0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">o3</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">18</span><span class="o">+</span><span class="n">t0_h</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">z1</span><span class="p">:],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">ps_t0</span> <span class="o">=</span> <span class="n">sfc_pres</span><span class="p">[</span><span class="n">t0</span><span class="p">]</span>
<span class="n">thetas_t0</span> <span class="o">=</span> <span class="n">sfc_theta</span><span class="p">[</span><span class="n">t0</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Extrapolate O3 since ERA5 only goes to 1 hPa and plot versus original profile</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Add top pressure and o3 value - here we assume o3 goes to zero at 1e-4 Pa</span>
<span class="n">pres_o3_t0_add_top</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pres_o3_t0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">pres_o3_t0</span><span class="p">),</span><span class="mf">0.0001</span><span class="p">)</span>
<span class="n">o3_t0_add_top</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">o3_t0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">o3_t0</span><span class="p">),</span><span class="mf">0.0</span><span class="p">)</span>

<span class="c1"># Add bottom pressure and o3 value - here we assume o3 is constant near the sfc</span>
<span class="n">pres_o3_t0_add_top_bottom</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pres_o3_t0_add_top</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">pres_t0</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">o3_t0_add_top_bottom</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">o3_t0_add_top</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">o3_t0</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

<span class="c1"># Do the extrapolation</span>
<span class="n">f</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span><span class="n">pres_o3_t0_add_top_bottom</span><span class="p">,</span> <span class="n">o3_t0_add_top_bottom</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span><span class="n">fill_value</span><span class="o">=</span><span class="s1">&#39;extrapolate&#39;</span><span class="p">)</span>
<span class="n">o3_t0i</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">pres_t0</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>

<span class="n">var_plt1</span> <span class="o">=</span> <span class="n">o3_t0</span>
<span class="n">var_plt2</span> <span class="o">=</span> <span class="n">o3_t0i</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">var_plt1</span><span class="p">,</span><span class="n">pres_o3_t0</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Original profile&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">var_plt2</span><span class="p">,</span><span class="n">pres_t0</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Extrapolated profile&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Ozone (kg kg-1)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Pressure (Pa)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;Figure size 640x480 with 0 Axes&gt;
</pre></div>
</div>
<img alt="../../_images/00f750941ff50712364eedcb817e252b2af38889467df0454c53ee5e2a52dab1.png" src="../../_images/00f750941ff50712364eedcb817e252b2af38889467df0454c53ee5e2a52dab1.png" />
</div>
</div>
</section>
<section id="get-geostrophic-wind-forcing">
<h2>Get Geostrophic wind forcing<a class="headerlink" href="#get-geostrophic-wind-forcing" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">do_geo</span><span class="p">:</span>
    <span class="c1"># Read ERA5 file</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">Dataset</span><span class="p">(</span><span class="n">fname_era5_geo</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span>

    <span class="n">zl</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">][</span><span class="mi">24</span><span class="o">-</span><span class="n">t0_h</span><span class="p">:</span><span class="mi">43</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,:,:]</span> <span class="c1"># time, lev, lat, lon</span>
    <span class="n">lonarrl</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;longitude&#39;</span><span class="p">][:]</span>
    <span class="n">latarrl</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;latitude&#39;</span><span class="p">][:]</span>

    <span class="n">latloc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">les_lat2</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>
    <span class="n">lonloc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">les_lat2</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>
    <span class="n">ugl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">les_lat2</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">zl</span><span class="p">)[</span><span class="mi">1</span><span class="p">]])</span>
    <span class="n">vgl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">les_lat2</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">zl</span><span class="p">)[</span><span class="mi">1</span><span class="p">]])</span>
    <span class="n">zhtl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">les_lat2</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">zl</span><span class="p">)[</span><span class="mi">1</span><span class="p">]])</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">les_lat2</span><span class="p">)):</span>
        <span class="n">hold</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">les_lat2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">latarrl</span><span class="p">)</span>
        <span class="n">latloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">hold</span><span class="p">)</span>
        <span class="n">hold</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">les_lon2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">lonarrl</span><span class="p">)</span>   
        <span class="n">lonloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">hold</span><span class="p">)</span>

        <span class="c1"># Coriolis parameter</span>
        <span class="n">e</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">omega</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">les_lat2</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
        <span class="n">f</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">omega</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">les_lat2</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>

        <span class="c1"># Calc dx, dy</span>
        <span class="n">offset1</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">offset2</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">coords_1</span> <span class="o">=</span> <span class="p">(</span><span class="n">latarrl</span><span class="p">[</span><span class="n">latloc</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="n">lonarrl</span><span class="p">[</span><span class="n">lonloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">offset2</span><span class="p">])</span>
        <span class="n">coords_2</span> <span class="o">=</span> <span class="p">(</span><span class="n">latarrl</span><span class="p">[</span><span class="n">latloc</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="n">lonarrl</span><span class="p">[</span><span class="n">lonloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="n">offset2</span><span class="p">])</span>
        <span class="n">dx</span> <span class="o">=</span> <span class="n">geopy</span><span class="o">.</span><span class="n">distance</span><span class="o">.</span><span class="n">geodesic</span><span class="p">(</span><span class="n">coords_1</span><span class="p">,</span> <span class="n">coords_2</span><span class="p">)</span><span class="o">.</span><span class="n">km</span>
        <span class="n">coords_3</span> <span class="o">=</span> <span class="p">(</span><span class="n">latarrl</span><span class="p">[</span><span class="n">latloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">offset1</span><span class="p">],</span> <span class="n">lonarrl</span><span class="p">[</span><span class="n">lonloc</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
        <span class="n">coords_4</span> <span class="o">=</span> <span class="p">(</span><span class="n">latarrl</span><span class="p">[</span><span class="n">latloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="n">offset1</span><span class="p">],</span> <span class="n">lonarrl</span><span class="p">[</span><span class="n">lonloc</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
        <span class="n">dy</span> <span class="o">=</span> <span class="n">geopy</span><span class="o">.</span><span class="n">distance</span><span class="o">.</span><span class="n">geodesic</span><span class="p">(</span><span class="n">coords_3</span><span class="p">,</span> <span class="n">coords_4</span><span class="p">)</span><span class="o">.</span><span class="n">km</span>
        <span class="k">while</span> <span class="n">dx</span> <span class="o">&lt;</span> <span class="n">min_dx</span><span class="p">:</span> <span class="c1"># we want at least min_dx km for our zonal discretization, which changes with time (latitude)</span>
            <span class="n">offset2</span><span class="o">+=</span><span class="mi">1</span>
            <span class="n">coords_1</span> <span class="o">=</span> <span class="p">(</span><span class="n">latarrl</span><span class="p">[</span><span class="n">latloc</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="n">lonarrl</span><span class="p">[</span><span class="n">lonloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">offset2</span><span class="p">])</span>
            <span class="n">coords_2</span> <span class="o">=</span> <span class="p">(</span><span class="n">latarrl</span><span class="p">[</span><span class="n">latloc</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="n">lonarrl</span><span class="p">[</span><span class="n">lonloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="n">offset2</span><span class="p">])</span>
            <span class="n">dx</span> <span class="o">=</span> <span class="n">geopy</span><span class="o">.</span><span class="n">distance</span><span class="o">.</span><span class="n">geodesic</span><span class="p">(</span><span class="n">coords_1</span><span class="p">,</span> <span class="n">coords_2</span><span class="p">)</span><span class="o">.</span><span class="n">km</span>
        <span class="k">while</span> <span class="n">dy</span> <span class="o">&lt;</span> <span class="n">min_dy</span><span class="p">:</span> <span class="c1"># we want at least min_dy km for our meridional discretization, which stays mostly constant with time (latitude)</span>
            <span class="n">offset1</span><span class="o">+=</span><span class="mi">1</span>
            <span class="n">coords_3</span> <span class="o">=</span> <span class="p">(</span><span class="n">latarrl</span><span class="p">[</span><span class="n">latloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">offset1</span><span class="p">],</span> <span class="n">lonarrl</span><span class="p">[</span><span class="n">lonloc</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
            <span class="n">coords_4</span> <span class="o">=</span> <span class="p">(</span><span class="n">latarrl</span><span class="p">[</span><span class="n">latloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="n">offset1</span><span class="p">],</span> <span class="n">lonarrl</span><span class="p">[</span><span class="n">lonloc</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
            <span class="n">dy</span> <span class="o">=</span> <span class="n">geopy</span><span class="o">.</span><span class="n">distance</span><span class="o">.</span><span class="n">geodesic</span><span class="p">(</span><span class="n">coords_3</span><span class="p">,</span> <span class="n">coords_4</span><span class="p">)</span><span class="o">.</span><span class="n">km</span>

        <span class="n">dx</span> <span class="o">=</span> <span class="n">dx</span><span class="o">*</span><span class="mf">1000.</span> <span class="c1"># km to m</span>
        <span class="n">dy</span> <span class="o">=</span> <span class="n">dy</span><span class="o">*</span><span class="mf">1000.</span>

        <span class="c1"># Calc Vg</span>
        <span class="n">ugl</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">1.</span><span class="o">/</span><span class="n">f</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">zl</span><span class="p">[</span><span class="n">i</span><span class="p">,:,</span><span class="n">latloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">offset1</span><span class="p">,</span><span class="n">lonloc</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">-</span><span class="n">zl</span><span class="p">[</span><span class="n">i</span><span class="p">,:,</span><span class="n">latloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="n">offset1</span><span class="p">,</span><span class="n">lonloc</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span><span class="o">/</span><span class="n">dy</span>
        <span class="n">vgl</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">f</span><span class="p">)</span>  <span class="o">*</span> <span class="p">(</span><span class="n">zl</span><span class="p">[</span><span class="n">i</span><span class="p">,:,</span><span class="n">latloc</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">lonloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="n">offset2</span><span class="p">]</span><span class="o">-</span><span class="n">zl</span><span class="p">[</span><span class="n">i</span><span class="p">,:,</span><span class="n">latloc</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">lonloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">offset2</span><span class="p">])</span><span class="o">/</span><span class="n">dx</span>
        <span class="n">zhtl</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">zl</span><span class="p">[</span><span class="n">i</span><span class="p">,:,</span><span class="n">latloc</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">lonloc</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">/</span><span class="n">g</span>

    <span class="n">ugeo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">ugl</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">vgeo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">vgl</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">zgeo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">zhtl</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">ugeo</span> <span class="o">=</span> <span class="n">gaussian_filter1d</span><span class="p">(</span><span class="n">ugeo</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">vgeo</span> <span class="o">=</span> <span class="n">gaussian_filter1d</span><span class="p">(</span><span class="n">vgeo</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;Geostrophic wind computed&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Geostrophic wind computed
</pre></div>
</div>
</div>
</div>
</section>
<section id="interpolate-profiles">
<h2>Interpolate profiles<a class="headerlink" href="#interpolate-profiles" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>Interpolate/extrapolate Ug/Vg to native ERA5 levels</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">do_geo</span><span class="p">:</span>
    <span class="n">ugeo_new</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">ugeo</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">hgt</span><span class="p">)[</span><span class="mi">1</span><span class="p">]])</span>
    <span class="n">vgeo_new</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">ugeo</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">hgt</span><span class="p">)[</span><span class="mi">1</span><span class="p">]])</span>
    <span class="n">zgeo_new</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">ugeo</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">hgt</span><span class="p">)[</span><span class="mi">1</span><span class="p">]])</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">les_lat2</span><span class="p">)):</span>
        <span class="n">zgeo_new</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">hgt</span><span class="p">[</span><span class="n">t0</span><span class="o">+</span><span class="n">i</span><span class="p">,</span><span class="n">z1</span><span class="p">:]</span>

        <span class="n">f</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span><span class="n">zgeo</span><span class="p">[</span><span class="n">i</span><span class="p">,:],</span> <span class="n">ugeo</span><span class="p">[</span><span class="n">i</span><span class="p">,:],</span> <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="s1">&#39;extrapolate&#39;</span><span class="p">)</span>
        <span class="n">ugeo_new</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">zgeo_new</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

        <span class="n">f</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span><span class="n">zgeo</span><span class="p">[</span><span class="n">i</span><span class="p">,:],</span> <span class="n">vgeo</span><span class="p">[</span><span class="n">i</span><span class="p">,:],</span> <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="s1">&#39;extrapolate&#39;</span><span class="p">)</span>
        <span class="n">vgeo_new</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">zgeo_new</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Interpolate t0 profiles, nudging profiles, and geostrophic wind profiles to common vertical grid for simplicity</p>
<ul class="simple">
<li><p>Find time with highest first level and get vertical grid</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">do_geo</span><span class="p">:</span>
    <span class="n">zz1_geo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="n">nhrs</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">pres_t0</span><span class="p">)])</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nhrs</span><span class="p">):</span>
        <span class="n">zz1_geo</span><span class="p">[</span><span class="n">count</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">zgeo_new</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">count</span><span class="o">+=</span><span class="mi">1</span>

    <span class="n">zz1_nudge</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="n">nhrs</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">pres_t0</span><span class="p">)])</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nhrs</span><span class="p">):</span>
        <span class="n">zz1_nudge</span><span class="p">[</span><span class="n">count</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">hgt</span><span class="p">[</span><span class="n">t0</span><span class="o">+</span><span class="n">i</span><span class="p">,</span><span class="n">z1</span><span class="p">:]</span>

        <span class="n">count</span><span class="o">+=</span><span class="mi">1</span>

    <span class="n">zz1_geo_max_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">zz1_geo</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">zz1_nudge_max_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">zz1_nudge</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">zz1_geo_max</span> <span class="o">=</span> <span class="n">zz1_geo</span><span class="p">[</span><span class="n">zz1_geo_max_idx</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">zz1_nudge_max</span> <span class="o">=</span> <span class="n">zz1_nudge</span><span class="p">[</span><span class="n">zz1_nudge_max_idx</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">zz1_geo_max</span> <span class="o">&gt;</span> <span class="n">zz1_nudge_max</span><span class="p">:</span>
        <span class="n">zgeoi</span> <span class="o">=</span> <span class="n">zz1_geo</span><span class="p">[</span><span class="n">zz1_geo_max_idx</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">zgeoi</span> <span class="o">=</span> <span class="n">zz1_nudge</span><span class="p">[</span><span class="n">zz1_nudge_max_idx</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        
<span class="k">else</span><span class="p">:</span>
    <span class="n">zz1_nudge</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="n">nhrs</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">pres_t0</span><span class="p">)])</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nhrs</span><span class="p">):</span>
        <span class="n">zz1_nudge</span><span class="p">[</span><span class="n">count</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">hgt</span><span class="p">[</span><span class="n">t0</span><span class="o">+</span><span class="n">i</span><span class="p">,</span><span class="n">z1</span><span class="p">:]</span>

        <span class="n">count</span><span class="o">+=</span><span class="mi">1</span>

    <span class="n">zz1_nudge_max_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">zz1_nudge</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">zz1_nudge_max</span> <span class="o">=</span> <span class="n">zz1_nudge</span><span class="p">[</span><span class="n">zz1_nudge_max_idx</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">zgeoi</span> <span class="o">=</span> <span class="n">zz1_nudge</span><span class="p">[</span><span class="n">zz1_nudge_max_idx</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;First level for all profiles = &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">zgeoi</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">3</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39; m&#39;</span> <span class="p">)</span>
<span class="nb">print</span> <span class="p">(</span><span class="n">zgeoi</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>First level for all profiles = 18.168 m
[1.81678200e+01 3.78291588e+01 5.93531876e+01 8.29409561e+01
 1.08634644e+02 1.36762817e+02 1.67474060e+02 2.01006256e+02
 2.37572968e+02 2.77470947e+02 3.20925720e+02 3.68243713e+02
 4.19705322e+02 4.75707489e+02 5.36504822e+02 6.02413635e+02
 6.73863464e+02 7.51188721e+02 8.34781677e+02 9.25015015e+02
 1.02229761e+03 1.12704102e+03 1.23956067e+03 1.36028394e+03
 1.48945679e+03 1.62738745e+03 1.77428064e+03 1.93038416e+03
 2.09574048e+03 2.27039331e+03 2.45438965e+03 2.64754395e+03
 2.84974072e+03 3.06066577e+03 3.27992432e+03 3.50704077e+03
 3.74134668e+03 3.98210889e+03 4.22867920e+03 4.48078857e+03
 4.73797949e+03 4.99874365e+03 5.26092578e+03 5.52306201e+03
 5.78483252e+03 6.04644922e+03 6.30803760e+03 6.56951123e+03
 6.83091602e+03 7.09283643e+03 7.35596924e+03 7.62092139e+03
 7.88798877e+03 8.15741553e+03 8.42925000e+03 8.70381738e+03
 8.98155176e+03 9.26270898e+03 9.54723730e+03 9.83502930e+03
 1.01259678e+04 1.04200625e+04 1.07173477e+04 1.10177529e+04
 1.13212578e+04 1.16278047e+04 1.19373662e+04 1.22498711e+04
 1.25653350e+04 1.28839326e+04 1.32058555e+04 1.35312275e+04
 1.38601523e+04 1.41925664e+04 1.45284150e+04 1.48675010e+04
 1.52095967e+04 1.55542930e+04 1.59013115e+04 1.62505469e+04
 1.66022949e+04 1.69575215e+04 1.73173887e+04 1.76829043e+04
 1.80547246e+04 1.84334707e+04 1.88199785e+04 1.92153418e+04
 1.96205273e+04 2.00361152e+04 2.04623945e+04 2.09000508e+04
 2.13498691e+04 2.18124043e+04 2.22871719e+04 2.27734141e+04
 2.32704062e+04 2.37781934e+04 2.42975605e+04 2.48301953e+04
 2.53780762e+04 2.59425137e+04 2.65239766e+04 2.71227988e+04
 2.77392344e+04 2.83741738e+04 2.90299805e+04 2.97107168e+04
 3.04193066e+04 3.11562773e+04 3.19218848e+04 3.27171895e+04
 3.35436523e+04 3.44022461e+04 3.52931797e+04 3.62169961e+04
 3.71792188e+04 3.82055078e+04 3.93279570e+04 4.05411719e+04
 4.18197422e+04 4.31656016e+04 4.45927344e+04 4.61026953e+04
 4.76934102e+04 4.93620195e+04 5.11093516e+04 5.29429336e+04
 5.48647773e+04 5.68720195e+04 5.89728828e+04 6.11852734e+04
 6.35144883e+04 6.59572734e+04 6.85121250e+04 7.11708984e+04]
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Do the linear interpolation of time-varying geostrophic profiles to new vertical grid</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">do_geo</span><span class="p">:</span>
    <span class="n">ugeoi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="n">nhrs</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">pres_t0</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">vgeoi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="n">nhrs</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">pres_t0</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nhrs</span><span class="p">):</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span><span class="n">zgeo_new</span><span class="p">[</span><span class="n">i</span><span class="p">,:],</span> <span class="n">ugeo_new</span><span class="p">[</span><span class="n">i</span><span class="p">,:])</span>
        <span class="n">ugeoi</span><span class="p">[</span><span class="n">count</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">zgeoi</span><span class="p">)</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span><span class="n">zgeo_new</span><span class="p">[</span><span class="n">i</span><span class="p">,:],</span> <span class="n">vgeo_new</span><span class="p">[</span><span class="n">i</span><span class="p">,:])</span>
        <span class="n">vgeoi</span><span class="p">[</span><span class="n">count</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">zgeoi</span><span class="p">)</span>

        <span class="n">count</span><span class="o">+=</span><span class="mi">1</span>
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Compare original and interpolated profiles of time-varying geostrophic wind as example to show efficacy of method</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">zplt1</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">zplt2</span> <span class="o">=</span> <span class="n">nhrs</span><span class="o">-</span><span class="mi">3</span>
<span class="n">zplt2b</span> <span class="o">=</span> <span class="mi">50</span>

<span class="k">if</span> <span class="n">do_geo</span><span class="p">:</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>

    <span class="n">var_plt1</span> <span class="o">=</span> <span class="n">ugeo</span>
    <span class="n">var_plt2</span> <span class="o">=</span> <span class="n">ugeoi</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">121</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nhrs</span><span class="p">):</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">var_plt1</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">zplt1</span><span class="p">:</span><span class="n">zplt2</span><span class="p">],</span><span class="n">zgeo</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">zplt1</span><span class="p">:</span><span class="n">zplt2</span><span class="p">],</span><span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">var_plt2</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">zplt1</span><span class="p">:</span><span class="n">zplt2b</span><span class="p">],</span><span class="n">zgeoi</span><span class="p">[</span><span class="n">zplt1</span><span class="p">:</span><span class="n">zplt2b</span><span class="p">],</span><span class="n">c</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;U$_</span><span class="si">{g}</span><span class="s1">$-wind (m s-1)&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Height ASL (m)&#39;</span><span class="p">)</span>

    <span class="n">var_plt1</span> <span class="o">=</span> <span class="n">vgeo</span>
    <span class="n">var_plt2</span> <span class="o">=</span> <span class="n">vgeoi</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">122</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nhrs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">var_plt1</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">zplt1</span><span class="p">:</span><span class="n">zplt2</span><span class="p">],</span><span class="n">zgeo</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">zplt1</span><span class="p">:</span><span class="n">zplt2</span><span class="p">],</span><span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Original profile&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">var_plt2</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">zplt1</span><span class="p">:</span><span class="n">zplt2b</span><span class="p">],</span><span class="n">zgeoi</span><span class="p">[</span><span class="n">zplt1</span><span class="p">:</span><span class="n">zplt2b</span><span class="p">],</span><span class="n">c</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Interpolated profile&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">var_plt1</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">zplt1</span><span class="p">:</span><span class="n">zplt2</span><span class="p">],</span><span class="n">zgeo</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">zplt1</span><span class="p">:</span><span class="n">zplt2</span><span class="p">],</span><span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">var_plt2</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">zplt1</span><span class="p">:</span><span class="n">zplt2b</span><span class="p">],</span><span class="n">zgeoi</span><span class="p">[</span><span class="n">zplt1</span><span class="p">:</span><span class="n">zplt2b</span><span class="p">],</span><span class="n">c</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;V$_</span><span class="si">{g}</span><span class="s1">$-wind (m s-1)&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;Figure size 640x480 with 0 Axes&gt;
</pre></div>
</div>
<img alt="../../_images/8e32984723c5b3a3ebff0707a92fccf057cf4234473db7e55ed0672daa62ca37.png" src="../../_images/8e32984723c5b3a3ebff0707a92fccf057cf4234473db7e55ed0672daa62ca37.png" />
</div>
</div>
<ul class="simple">
<li><p>Do the linear interpolation for initial forcing profiles</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">f</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span><span class="n">hgt_t0</span><span class="p">,</span> <span class="n">pres_t0</span><span class="p">)</span>
<span class="n">pres_t0i</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">zgeoi</span><span class="p">)</span>
<span class="n">f</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span><span class="n">hgt_t0</span><span class="p">,</span> <span class="n">uwnd_t0</span><span class="p">)</span>
<span class="n">uwnd_t0i</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">zgeoi</span><span class="p">)</span>
<span class="n">f</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span><span class="n">hgt_t0</span><span class="p">,</span> <span class="n">vwnd_t0</span><span class="p">)</span>
<span class="n">vwnd_t0i</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">zgeoi</span><span class="p">)</span>
<span class="n">f</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span><span class="n">zgeoi</span><span class="p">,</span> <span class="n">ugeoi</span><span class="p">[</span><span class="mi">0</span><span class="p">,:])</span>
<span class="n">ugeoi_t0i</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">zgeoi</span><span class="p">)</span>
<span class="n">f</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span><span class="n">zgeoi</span><span class="p">,</span> <span class="n">vgeoi</span><span class="p">[</span><span class="mi">0</span><span class="p">,:])</span>
<span class="n">vgeoi_t0i</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">zgeoi</span><span class="p">)</span>
<span class="n">f</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span><span class="n">hgt_t0</span><span class="p">,</span> <span class="n">wwnd_t0</span><span class="p">)</span>
<span class="n">wwnd_t0i</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">zgeoi</span><span class="p">)</span>
<span class="n">f</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span><span class="n">hgt_t0</span><span class="p">,</span> <span class="n">temp_t0</span><span class="p">)</span>
<span class="n">temp_t0i</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">zgeoi</span><span class="p">)</span>
<span class="n">f</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span><span class="n">hgt_t0</span><span class="p">,</span> <span class="n">theta_t0</span><span class="p">)</span>
<span class="n">theta_t0i</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">zgeoi</span><span class="p">)</span>
<span class="n">f</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span><span class="n">hgt_t0</span><span class="p">,</span> <span class="n">qv_t0</span><span class="p">)</span>
<span class="n">qv_t0i</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">zgeoi</span><span class="p">)</span>
<span class="n">f</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span><span class="n">hgt_t0</span><span class="p">,</span> <span class="n">o3_t0i</span><span class="p">)</span>
<span class="n">o3_t0i</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">zgeoi</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Do the linear interpolation for nudging forcing profiles</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">do_u_v_nudge</span><span class="p">:</span>
    <span class="n">unudgei</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="n">nhrs</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">pres_t0</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">vnudgei</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="n">nhrs</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">pres_t0</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<span class="k">if</span> <span class="n">do_th_qv_nudge</span><span class="p">:</span>
    <span class="n">tnudgei</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="n">nhrs</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">pres_t0</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">qvnudgei</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="n">nhrs</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">pres_t0</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<span class="k">if</span> <span class="n">do_subsidence</span><span class="p">:</span>
    <span class="n">wnudgei</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="n">nhrs</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">pres_t0</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">if</span> <span class="n">do_u_v_nudge</span> <span class="ow">or</span> <span class="n">do_th_qv_nudge</span> <span class="ow">or</span> <span class="n">do_subsidence</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nhrs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">do_u_v_nudge</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span><span class="n">hgt</span><span class="p">[</span><span class="n">t0</span><span class="o">+</span><span class="n">i</span><span class="p">,</span><span class="n">z1</span><span class="p">:],</span> <span class="n">uwnd</span><span class="p">[</span><span class="n">t0</span><span class="o">+</span><span class="n">i</span><span class="p">,</span><span class="n">z1</span><span class="p">:])</span>
            <span class="n">unudgei</span><span class="p">[</span><span class="n">count</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">zgeoi</span><span class="p">)</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span><span class="n">hgt</span><span class="p">[</span><span class="n">t0</span><span class="o">+</span><span class="n">i</span><span class="p">,</span><span class="n">z1</span><span class="p">:],</span> <span class="n">vwnd</span><span class="p">[</span><span class="n">t0</span><span class="o">+</span><span class="n">i</span><span class="p">,</span><span class="n">z1</span><span class="p">:])</span>
            <span class="n">vnudgei</span><span class="p">[</span><span class="n">count</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">zgeoi</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">do_th_qv_nudge</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span><span class="n">hgt</span><span class="p">[</span><span class="n">t0</span><span class="o">+</span><span class="n">i</span><span class="p">,</span><span class="n">z1</span><span class="p">:],</span> <span class="n">theta</span><span class="p">[</span><span class="n">t0</span><span class="o">+</span><span class="n">i</span><span class="p">,</span><span class="n">z1</span><span class="p">:])</span>
            <span class="n">tnudgei</span><span class="p">[</span><span class="n">count</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">zgeoi</span><span class="p">)</span>

            <span class="n">f</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span><span class="n">hgt</span><span class="p">[</span><span class="n">t0</span><span class="o">+</span><span class="n">i</span><span class="p">,</span><span class="n">z1</span><span class="p">:],</span> <span class="n">qv</span><span class="p">[</span><span class="n">t0</span><span class="o">+</span><span class="n">i</span><span class="p">,</span><span class="n">z1</span><span class="p">:])</span>
            <span class="n">qvnudgei</span><span class="p">[</span><span class="n">count</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">zgeoi</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">do_subsidence</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span><span class="n">hgt</span><span class="p">[</span><span class="n">t0</span><span class="o">+</span><span class="n">i</span><span class="p">,</span><span class="n">z1</span><span class="p">:],</span> <span class="n">wwnd</span><span class="p">[</span><span class="n">t0</span><span class="o">+</span><span class="n">i</span><span class="p">,</span><span class="n">z1</span><span class="p">:])</span>
            <span class="n">wnudgei</span><span class="p">[</span><span class="n">count</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">zgeoi</span><span class="p">)</span>

        <span class="n">count</span><span class="o">+=</span><span class="mi">1</span>
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Compare original and interpolated profiles of time-varying nudging wind as example to show efficacy of method</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">zplt1</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">zplt2</span> <span class="o">=</span> <span class="mi">50</span>
<span class="n">zplt2b</span> <span class="o">=</span> <span class="mi">50</span>

<span class="k">if</span> <span class="n">do_geo</span> <span class="ow">and</span> <span class="n">do_u_v_nudge</span><span class="p">:</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>

    <span class="n">var_plt1</span> <span class="o">=</span> <span class="n">uwnd</span>
    <span class="n">var_plt2</span> <span class="o">=</span> <span class="n">unudgei</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">121</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nhrs</span><span class="p">):</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">var_plt1</span><span class="p">[</span><span class="n">t0</span><span class="o">+</span><span class="n">i</span><span class="p">,</span><span class="n">zplt1</span><span class="p">:</span><span class="n">zplt2</span><span class="p">],</span><span class="n">hgt</span><span class="p">[</span><span class="n">t0</span><span class="o">+</span><span class="n">i</span><span class="p">,</span><span class="n">zplt1</span><span class="p">:</span><span class="n">zplt2</span><span class="p">],</span><span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">var_plt2</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">zplt1</span><span class="p">:</span><span class="n">zplt2b</span><span class="p">],</span><span class="n">zgeoi</span><span class="p">[</span><span class="n">zplt1</span><span class="p">:</span><span class="n">zplt2b</span><span class="p">],</span><span class="n">c</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;U-wind (m s-1)&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Height ASL (m)&#39;</span><span class="p">)</span>

    <span class="n">var_plt1</span> <span class="o">=</span> <span class="n">vwnd</span>
    <span class="n">var_plt2</span> <span class="o">=</span> <span class="n">vnudgei</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">122</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nhrs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">var_plt1</span><span class="p">[</span><span class="n">t0</span><span class="o">+</span><span class="n">i</span><span class="p">,</span><span class="n">zplt1</span><span class="p">:</span><span class="n">zplt2</span><span class="p">],</span><span class="n">hgt</span><span class="p">[</span><span class="n">t0</span><span class="o">+</span><span class="n">i</span><span class="p">,</span><span class="n">zplt1</span><span class="p">:</span><span class="n">zplt2</span><span class="p">],</span><span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Original profile&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">var_plt2</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">zplt1</span><span class="p">:</span><span class="n">zplt2b</span><span class="p">],</span><span class="n">zgeoi</span><span class="p">[</span><span class="n">zplt1</span><span class="p">:</span><span class="n">zplt2b</span><span class="p">],</span><span class="n">c</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Interpolated profile&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">var_plt1</span><span class="p">[</span><span class="n">t0</span><span class="o">+</span><span class="n">i</span><span class="p">,</span><span class="n">zplt1</span><span class="p">:</span><span class="n">zplt2</span><span class="p">],</span><span class="n">hgt</span><span class="p">[</span><span class="n">t0</span><span class="o">+</span><span class="n">i</span><span class="p">,</span><span class="n">zplt1</span><span class="p">:</span><span class="n">zplt2</span><span class="p">],</span><span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">var_plt2</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">zplt1</span><span class="p">:</span><span class="n">zplt2b</span><span class="p">],</span><span class="n">zgeoi</span><span class="p">[</span><span class="n">zplt1</span><span class="p">:</span><span class="n">zplt2b</span><span class="p">],</span><span class="n">c</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;V-wind (m s-1)&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/49aae2893181c4e4ae6448c9af7483e6f872c83f33db202855e352c3b998ee43.png" src="../../_images/49aae2893181c4e4ae6448c9af7483e6f872c83f33db202855e352c3b998ee43.png" />
</div>
</div>
</section>
<section id="smooth-initial-water-vapor-mixing-ratio-profile">
<h2>Smooth initial water vapor mixing ratio profile<a class="headerlink" href="#smooth-initial-water-vapor-mixing-ratio-profile" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">qv_t0i_mod</span> <span class="o">=</span> <span class="n">qv_t0i</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">qv_t0i_mod</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.27e-3</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">qv_t0i</span><span class="o">*</span><span class="mf">1e3</span><span class="p">,</span><span class="n">zgeoi</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Original&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">qv_t0i_mod</span><span class="o">*</span><span class="mf">1e3</span><span class="p">,</span><span class="n">zgeoi</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Smooth&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3500</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.legend.Legend at 0x148720d309a0&gt;
</pre></div>
</div>
<img alt="../../_images/02d63d2bc31bddb44bb1042fba4739e9a71217cb8f5d2629e353cef88f82ee53.png" src="../../_images/02d63d2bc31bddb44bb1042fba4739e9a71217cb8f5d2629e353cef88f82ee53.png" />
</div>
</div>
</section>
<section id="do-surface-forcing">
<h2>Do surface forcing<a class="headerlink" href="#do-surface-forcing" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>Calculate sea ice concentration along trajectory</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sic_file</span> <span class="o">=</span> <span class="n">Dataset</span><span class="p">(</span><span class="n">fname_sic</span><span class="p">)</span>
<span class="n">sic</span> <span class="o">=</span> <span class="n">sic_file</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">][:,:]</span>
<span class="n">sic_lat</span> <span class="o">=</span> <span class="n">sic_file</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">][:]</span>
<span class="n">sic_lon</span> <span class="o">=</span> <span class="n">sic_file</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">][:]</span>

<span class="n">sic_traj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">les_hh_idx</span><span class="p">))</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">les_hh_idx</span><span class="p">)):</span>
    <span class="n">abslat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">sic_lat</span><span class="o">-</span><span class="n">les_lat</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">abslon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">sic_lon</span><span class="o">-</span><span class="n">les_lon</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">jlat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">abslat</span><span class="p">)</span>
    <span class="n">ilon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">abslon</span><span class="p">)</span>
    <span class="n">sic_traj</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sic</span><span class="p">[</span><span class="n">jlat</span><span class="p">,</span><span class="n">ilon</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Get time series information for sfc forcing</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Print statements?</span>
<span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span>

<span class="c1"># Pack ice skin temperature</span>
<span class="n">tsk_ice</span> <span class="o">=</span> <span class="mf">247.0</span>

<span class="c1"># Interpolate SST</span>
<span class="n">tmp_hh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="n">t0_h</span><span class="p">,</span><span class="mi">19</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># these are the hours we have SST data from the ERA5 backward trajectory file</span>
<span class="n">f</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span><span class="n">tmp_hh</span><span class="p">,</span> <span class="n">sst</span><span class="p">[</span><span class="n">t0</span><span class="p">:])</span>
<span class="n">sst_interp</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">les_hh</span><span class="p">[</span><span class="n">les_hh_idx</span><span class="p">])</span>

<span class="c1"># Modification for over ice/MIZ</span>
<span class="n">sst_ts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sic_traj</span><span class="p">))</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sic_traj</span><span class="p">)):</span>
    <span class="k">if</span> <span class="n">sic_traj</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">90.0</span><span class="p">:</span> <span class="c1"># over ice</span>
        <span class="n">sst_ts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">tsk_ice</span>
    <span class="k">elif</span> <span class="n">sic_traj</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span> <span class="c1"># MIZ</span>
        <span class="n">sst_ts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">sic_traj</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="mf">100.</span><span class="p">)</span><span class="o">*</span><span class="n">tsk_ice</span> <span class="o">+</span> <span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="p">(</span><span class="n">sic_traj</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="mf">100.</span><span class="p">))</span><span class="o">*</span><span class="n">sst_interp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="c1"># MIZ</span>
    <span class="k">else</span><span class="p">:</span> <span class="c1"># open ocean</span>
        <span class="n">sst_ts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sst_interp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;Computed TSK for hour &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="mi">5</span><span class="o">*</span><span class="n">i</span><span class="o">/</span><span class="mf">60.</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;: &#39;</span>
               <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">sst_ts</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="mi">3</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39; with SIC = &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">sic_traj</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="mf">100.</span><span class="p">)</span> <span class="o">+</span>
               <span class="s1">&#39; and SST = &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">sst_interp</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="mi">3</span><span class="p">)))</span>

<span class="c1"># Pull hourly SST</span>
<span class="n">sst_ts</span> <span class="o">=</span> <span class="n">sst_ts</span><span class="p">[::</span><span class="mi">12</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="create-new-netcdf-file">
<h2>Create new netcdf file<a class="headerlink" href="#create-new-netcdf-file" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">try</span><span class="p">:</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>  <span class="c1"># just to be safe, make sure dataset is not already open.</span>
<span class="k">except</span><span class="p">:</span> <span class="k">pass</span>
<span class="n">ncfile</span> <span class="o">=</span> <span class="n">Dataset</span><span class="p">(</span><span class="n">save_name</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span><span class="nb">format</span><span class="o">=</span><span class="s1">&#39;NETCDF3_CLASSIC&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Create dimensions</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">levs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">zgeoi</span><span class="p">)</span>
<span class="n">z_grid_levs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">z_grid</span><span class="p">)</span>
<span class="n">t0_dim</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createDimension</span><span class="p">(</span><span class="s1">&#39;t0&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>     <span class="c1"># initial time axis</span>
<span class="n">lat_dim</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createDimension</span><span class="p">(</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>     <span class="c1"># latitude axis</span>
<span class="n">lon_dim</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createDimension</span><span class="p">(</span><span class="s1">&#39;lon&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>     <span class="c1"># longitude axis</span>
<span class="n">lev_dim</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createDimension</span><span class="p">(</span><span class="s1">&#39;lev&#39;</span><span class="p">,</span> <span class="n">levs</span><span class="p">)</span>      <span class="c1"># level axis</span>
<span class="n">zw_grid_dim</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createDimension</span><span class="p">(</span><span class="s1">&#39;zw_grid&#39;</span><span class="p">,</span> <span class="n">z_grid_levs</span><span class="p">)</span>      <span class="c1"># zw_grid axis</span>
<span class="n">time_dim</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createDimension</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>    <span class="c1"># unlimited axis (can be appended to)</span>
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Create global attributes</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ncfile</span><span class="o">.</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;Forcing and initial conditions for 13 March 2020 COMBLE intercomparison case&#39;</span>
<span class="n">ncfile</span><span class="o">.</span><span class="n">reference</span><span class="o">=</span><span class="s1">&#39;https://arm-development.github.io/comble-mip/&#39;</span>
<span class="n">ncfile</span><span class="o">.</span><span class="n">authors</span><span class="o">=</span><span class="s1">&#39;Timothy W. Juliano (NCAR/RAL, tjuliano@ucar.edu); Florian Tornow (NASA/GISS, ft2544@columbia.edu); Ann M. Fridlind (NASA/GISS, ann.fridlind@nasa.gov)&#39;</span>
<span class="n">ncfile</span><span class="o">.</span><span class="n">version</span><span class="o">=</span><span class="s1">&#39;Created on &#39;</span> <span class="o">+</span> <span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">ncfile</span><span class="o">.</span><span class="n">format_version</span><span class="o">=</span><span class="s1">&#39;DEPHY SCM format version 2.0&#39;</span>
<span class="n">ncfile</span><span class="o">.</span><span class="n">script</span><span class="o">=</span><span class="n">script_name</span>
<span class="n">ncfile</span><span class="o">.</span><span class="n">startDate</span><span class="o">=</span><span class="n">start_time</span>
<span class="n">ncfile</span><span class="o">.</span><span class="n">endDate</span><span class="o">=</span><span class="s1">&#39;2020-03-13 18:00:00&#39;</span>
<span class="k">if</span> <span class="n">do_geo</span><span class="p">:</span>
    <span class="n">ncfile</span><span class="o">.</span><span class="n">forc_geo</span><span class="o">=</span><span class="mi">1</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">ncfile</span><span class="o">.</span><span class="n">forc_geo</span><span class="o">=</span><span class="mi">0</span>
<span class="n">ncfile</span><span class="o">.</span><span class="n">radiation</span><span class="o">=</span><span class="s1">&#39;on&#39;</span>
<span class="n">ncfile</span><span class="o">.</span><span class="n">forc_wap</span><span class="o">=</span><span class="mi">0</span>
<span class="n">ncfile</span><span class="o">.</span><span class="n">forc_wa</span><span class="o">=</span><span class="mi">0</span>
<span class="n">ncfile</span><span class="o">.</span><span class="n">surface_type</span><span class="o">=</span><span class="s1">&#39;ocean&#39;</span>
<span class="n">ncfile</span><span class="o">.</span><span class="n">surface_forcing_temp</span><span class="o">=</span><span class="s1">&#39;ts&#39;</span>
<span class="n">ncfile</span><span class="o">.</span><span class="n">z0h</span><span class="o">=</span><span class="s1">&#39;5.5e-6 m&#39;</span>
<span class="n">ncfile</span><span class="o">.</span><span class="n">surface_forcing_moisture</span><span class="o">=</span><span class="s1">&#39;none&#39;</span>
<span class="n">ncfile</span><span class="o">.</span><span class="n">z0q</span><span class="o">=</span><span class="s1">&#39;5.5e-6 m&#39;</span>
<span class="n">ncfile</span><span class="o">.</span><span class="n">surface_forcing_wind</span><span class="o">=</span><span class="s1">&#39;z0&#39;</span>
<span class="n">ncfile</span><span class="o">.</span><span class="n">z0</span><span class="o">=</span><span class="s1">&#39;9.0e-4 m&#39;</span>
<span class="n">ncfile</span><span class="o">.</span><span class="n">lat</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">les_lat_mid</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; deg N&#39;</span>
<span class="n">ncfile</span><span class="o">.</span><span class="n">droplet_activation_diagnostic</span><span class="o">=</span><span class="s1">&#39;droplet number concentration fixed to 20 cm-3&#39;</span>
<span class="n">ncfile</span><span class="o">.</span><span class="n">ice_nucleation_diagnostic</span><span class="o">=</span><span class="s1">&#39;total ice number concentration fixed to 25 L-1 where qc+qr&gt;1e-6 kg/kg and T&lt;268.15 K&#39;</span>
<span class="n">ncfile</span><span class="o">.</span><span class="n">droplet_activation_prognostic</span><span class="o">=</span><span class="s1">&#39;time and space varying aerosol initialized from na1, na2 and na3, which are uniform initial profiles to be affected by collision-coalescence processes, sea spray source, and mixing&#39;</span>
<span class="n">ncfile</span><span class="o">.</span><span class="n">aerosol_surface_source</span><span class="o">=</span><span class="s1">&#39;modal emissions based on Jaegle et al. (2011)</span><span class="se">\&#39;</span><span class="s1">s size-resolved surface source fluxes (equation 4) that vary as a function of wind speed and SST; from size-integrated fluxes we determine proportional attribution to the two larger modes via modal geometric mean and standard deviation of the accumulation mode (na2); for the configuration here: 98.5% (accumulation mode, na2) and 1.5% (sea spray mode, na3)&#39;</span>
<span class="n">ncfile</span><span class="o">.</span><span class="n">ice_nucleation_prognostic</span><span class="o">=</span><span class="s1">&#39;assume that all sea spray mode and half of internally mixed accumulation mode aerosols behave as ice nucleating particles in the immersion mode, and apply parameterization of choice&#39;</span>
</pre></div>
</div>
</div>
</div>
<p>Create variables</p>
<ul class="simple">
<li><p>Dimensions</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">t0_time</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;t0&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;t0&#39;</span><span class="p">,))</span>
<span class="n">t0_time</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;seconds since &#39;</span> <span class="o">+</span> <span class="n">start_time</span>
<span class="n">t0_time</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;Initial time&#39;</span>

<span class="n">latitude</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;lat&#39;</span><span class="p">,))</span>
<span class="n">latitude</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;degrees_north&#39;</span>
<span class="n">latitude</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;latitude&#39;</span>

<span class="n">longitude</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;lon&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;lon&#39;</span><span class="p">,))</span>
<span class="n">longitude</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;degrees_east&#39;</span>
<span class="n">longitude</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;longitude&#39;</span>

<span class="n">time</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,))</span>
<span class="n">time</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;seconds since &#39;</span> <span class="o">+</span> <span class="n">start_time</span>
<span class="n">time</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;time&#39;</span>

<span class="n">lev</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;lev&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;lev&#39;</span><span class="p">,))</span>
<span class="n">lev</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;m&#39;</span>
<span class="n">lev</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;altitude&#39;</span>
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Initial profiles</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pressure</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;pressure&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;t0&#39;</span><span class="p">,</span><span class="s1">&#39;lev&#39;</span><span class="p">,</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span><span class="s1">&#39;lon&#39;</span><span class="p">,))</span>
<span class="n">pressure</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;Pa&#39;</span>
<span class="n">pressure</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;pressure&#39;</span>

<span class="n">u</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;u&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;t0&#39;</span><span class="p">,</span><span class="s1">&#39;lev&#39;</span><span class="p">,</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span><span class="s1">&#39;lon&#39;</span><span class="p">,))</span>
<span class="n">u</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;m s-1&#39;</span>
<span class="n">u</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;zonal wind&#39;</span>

<span class="n">v</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;v&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;t0&#39;</span><span class="p">,</span><span class="s1">&#39;lev&#39;</span><span class="p">,</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span><span class="s1">&#39;lon&#39;</span><span class="p">,))</span>
<span class="n">v</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;m s-1&#39;</span>
<span class="n">v</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;meridional wind&#39;</span>

<span class="n">temperature</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;temp&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;t0&#39;</span><span class="p">,</span><span class="s1">&#39;lev&#39;</span><span class="p">,</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span><span class="s1">&#39;lon&#39;</span><span class="p">,))</span>
<span class="n">temperature</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;K&#39;</span>
<span class="n">temperature</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;temperature&#39;</span>

<span class="n">ptemperature</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;theta&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;t0&#39;</span><span class="p">,</span><span class="s1">&#39;lev&#39;</span><span class="p">,</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span><span class="s1">&#39;lon&#39;</span><span class="p">,))</span>
<span class="n">ptemperature</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;K&#39;</span>
<span class="n">ptemperature</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;potential temperature&#39;</span>

<span class="n">qvapor</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;qv&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;t0&#39;</span><span class="p">,</span><span class="s1">&#39;lev&#39;</span><span class="p">,</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span><span class="s1">&#39;lon&#39;</span><span class="p">,))</span>
<span class="n">qvapor</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;kg kg-1&#39;</span>
<span class="n">qvapor</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;specific humidity&#39;</span>

<span class="n">ozone</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;o3&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;t0&#39;</span><span class="p">,</span><span class="s1">&#39;lev&#39;</span><span class="p">,</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span><span class="s1">&#39;lon&#39;</span><span class="p">,))</span>
<span class="n">ozone</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;kg kg-1&#39;</span>
<span class="n">ozone</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;ozone mass mixing ratio&#39;</span>
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Initial sfc conditions</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ps</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;ps&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;t0&#39;</span><span class="p">,</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span><span class="s1">&#39;lon&#39;</span><span class="p">,))</span>
<span class="n">ps</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;Pa&#39;</span>
<span class="n">ps</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;surface pressure&#39;</span>

<span class="n">thetas</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;thetas&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;t0&#39;</span><span class="p">,</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span><span class="s1">&#39;lon&#39;</span><span class="p">,))</span>
<span class="n">thetas</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;K&#39;</span>
<span class="n">thetas</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;surface potential temperature&#39;</span>
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Time-varying forcing - geostrophic</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">do_geo</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">ug</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;ug&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="s1">&#39;lev&#39;</span><span class="p">,))</span>
    <span class="n">ug</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;m s-1&#39;</span>
    <span class="n">ug</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;geostrophic zonal wind&#39;</span>

    <span class="n">vg</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;vg&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="s1">&#39;lev&#39;</span><span class="p">,))</span>
    <span class="n">vg</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;m s-1&#39;</span>
    <span class="n">vg</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;geostrophic meridional wind&#39;</span>
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Time-varying forcing - nudging</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">do_u_v_nudge</span><span class="p">:</span>
    <span class="n">u_nudging</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;u_nudging&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="s1">&#39;lev&#39;</span><span class="p">,))</span>
    <span class="n">u_nudging</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;m s-1&#39;</span>
    <span class="n">u_nudging</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;zonal wind profile for nudging&#39;</span>

    <span class="n">v_nudging</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;v_nudging&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="s1">&#39;lev&#39;</span><span class="p">,))</span>
    <span class="n">v_nudging</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;m s-1&#39;</span>
    <span class="n">v_nudging</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;meridional wind profile for nudging&#39;</span>

<span class="k">if</span> <span class="n">do_th_qv_nudge</span><span class="p">:</span>
    <span class="n">theta_nudging</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;theta_nudging&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="s1">&#39;lev&#39;</span><span class="p">,))</span>
    <span class="n">theta_nudging</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;K&#39;</span>
    <span class="n">theta_nudging</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;potential temperature profile for nudging&#39;</span>

    <span class="n">qv_nudging</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;qv_nudging&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="s1">&#39;lev&#39;</span><span class="p">,))</span>
    <span class="n">qv_nudging</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;kg kg-1&#39;</span>
    <span class="n">qv_nudging</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;specific humidity profile for nudging&#39;</span>
    
<span class="k">if</span> <span class="n">do_subsidence</span><span class="p">:</span>
    <span class="n">w_nudging</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;w_nudging&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="s1">&#39;lev&#39;</span><span class="p">,))</span>
    <span class="n">w_nudging</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;Pa s-1&#39;</span>
    <span class="n">w_nudging</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;vertical velocity for nudging&#39;</span>
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Time-varying forcing - surface</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ts</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;ts&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,))</span>
<span class="n">ts</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;K&#39;</span>
<span class="n">ts</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;surface temperature&#39;</span>
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Time-varying locations</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">latitude_arr</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;lat_ref&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,))</span>
<span class="n">latitude_arr</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;degrees_north&#39;</span>
<span class="n">latitude_arr</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;reference latitude&#39;</span>

<span class="n">longitude_arr</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;lon_ref&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,))</span>
<span class="n">longitude_arr</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;degrees_east&#39;</span>
<span class="n">longitude_arr</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;reference longitude&#39;</span>
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Misc</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">zw_grid</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;zw_grid&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;zw_grid&#39;</span><span class="p">,))</span>
<span class="n">zw_grid</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;m&#39;</span>
<span class="n">zw_grid</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;grid altitude at cell faces&#39;</span>
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Write data</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">t0_time</span><span class="p">[:]</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="n">latitude</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">les_lat_mid</span>
<span class="n">longitude</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">les_lon_mid</span>
<span class="n">latitude_arr</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">les_lat2</span>
<span class="n">longitude_arr</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">les_lon2</span>
<span class="n">lev</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">zgeoi</span>
<span class="n">zw_grid</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">z_grid</span>
<span class="n">pressure</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">pres_t0i</span>
<span class="n">u</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">ugeoi_t0i</span>
<span class="n">v</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">vgeoi_t0i</span>
<span class="n">temperature</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">temp_t0i</span>
<span class="n">ptemperature</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">theta_t0i</span>
<span class="n">qvapor</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">qv_t0i_mod</span>
<span class="n">ozone</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">o3_t0i</span>

<span class="n">ps</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">ps_t0</span>
<span class="n">thetas</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">thetas_t0</span>

<span class="k">if</span> <span class="n">do_geo</span><span class="p">:</span>
    <span class="n">ug</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">ugeoi</span>
    <span class="n">vg</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">vgeoi</span>

<span class="k">if</span> <span class="n">do_u_v_nudge</span><span class="p">:</span>
    <span class="n">u_nudging</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">unudgei</span>
    <span class="n">v_nudging</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">vnudgei</span>

<span class="k">if</span> <span class="n">do_th_qv_nudge</span><span class="p">:</span>
    <span class="n">theta_nudging</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">tnudgei</span>
    <span class="n">qv_nudging</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">qvnudgei</span>
    
<span class="k">if</span> <span class="n">do_subsidence</span><span class="p">:</span>
    <span class="n">w_nudging</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">wnudgei</span>
    
<span class="n">ts</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">sst_ts</span>
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Add times</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dates</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nhrs</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">nhrs</span> <span class="o">==</span> <span class="mi">19</span><span class="p">:</span>
        <span class="n">dates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2020</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="n">i</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span> <span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2020</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="n">i</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">start_hour</span><span class="o">+</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">23</span><span class="p">:</span>
            <span class="n">dates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2020</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="n">start_hour</span><span class="o">+</span><span class="n">i</span><span class="o">-</span><span class="mi">24</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span> <span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2020</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="n">start_hour</span><span class="o">+</span><span class="n">i</span><span class="o">-</span><span class="mi">24</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2020</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="n">start_hour</span><span class="o">+</span><span class="n">i</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span> <span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2020</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="n">start_hour</span><span class="o">+</span><span class="n">i</span><span class="p">))</span>
<span class="n">times</span> <span class="o">=</span> <span class="n">date2num</span><span class="p">(</span><span class="n">dates</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">units</span><span class="p">)</span>
<span class="n">time</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">times</span>
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Close the file</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># first print the Dataset object to see what we&#39;ve got</span>
<span class="nb">print</span><span class="p">(</span><span class="n">ncfile</span><span class="p">)</span>
<span class="c1"># close the Dataset.</span>
<span class="n">ncfile</span><span class="o">.</span><span class="n">close</span><span class="p">();</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Dataset is closed!&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;class &#39;netCDF4._netCDF4.Dataset&#39;&gt;
root group (NETCDF3_CLASSIC data model, file format NETCDF3):
    title: Forcing and initial conditions for 13 March 2020 COMBLE intercomparison case
    reference: https://arm-development.github.io/comble-mip/
    authors: Timothy W. Juliano (NCAR/RAL, tjuliano@ucar.edu); Florian Tornow (NASA/GISS, ft2544@columbia.edu); Ann M. Fridlind (NASA/GISS, ann.fridlind@nasa.gov)
    version: Created on 2023-12-01
    format_version: DEPHY SCM format version 2.0
    script: create_comble_forcing_v2.3.ipynb
    startDate: 2020-03-12 22:00:00
    endDate: 2020-03-13 18:00:00
    forc_geo: 1
    radiation: on
    forc_wap: 0
    forc_wa: 0
    surface_type: ocean
    surface_forcing_temp: ts
    z0h: 5.5e-6 m
    surface_forcing_moisture: none
    z0q: 5.5e-6 m
    surface_forcing_wind: z0
    z0: 9.0e-4 m
    lat: 74.5 deg N
    droplet_activation_diagnostic: droplet number concentration fixed to 20 cm-3
    ice_nucleation_diagnostic: total ice number concentration fixed to 25 L-1 where qc+qr&gt;1e-6 kg/kg and T&lt;268.15 K
    droplet_activation_prognostic: time and space varying aerosol initialized from na1, na2 and na3, which are uniform initial profiles to be affected by collision-coalescence processes, sea spray source, and mixing
    aerosol_surface_source: modal emissions based on Jaegle et al. (2011)&#39;s size-resolved surface source fluxes (equation 4) that vary as a function of wind speed and SST; from size-integrated fluxes we determine proportional attribution to the two larger modes via modal geometric mean and standard deviation of the accumulation mode (na2); for the configuration here: 98.5% (accumulation mode, na2) and 1.5% (sea spray mode, na3)
    ice_nucleation_prognostic: assume that all sea spray mode and half of internally mixed accumulation mode aerosols behave as ice nucleating particles in the immersion mode, and apply parameterization of choice
    dimensions(sizes): t0(1), lat(1), lon(1), lev(136), zw_grid(160), time(21)
    variables(dimensions): float32 t0(t0), float32 lat(lat), float32 lon(lon), float64 time(time), float64 lev(lev), float64 pressure(t0, lev, lat, lon), float64 u(t0, lev, lat, lon), float64 v(t0, lev, lat, lon), float64 temp(t0, lev, lat, lon), float64 theta(t0, lev, lat, lon), float64 qv(t0, lev, lat, lon), float64 o3(t0, lev, lat, lon), float64 ps(t0, lat, lon), float64 thetas(t0, lat, lon), float64 ug(time, lev), float64 vg(time, lev), float64 u_nudging(time, lev), float64 v_nudging(time, lev), float64 theta_nudging(time, lev), float64 qv_nudging(time, lev), float64 w_nudging(time, lev), float64 ts(time), float32 lat_ref(time), float32 lon_ref(time), float64 zw_grid(zw_grid)
    groups: 
Dataset is closed!
</pre></div>
</div>
</div>
</div>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./notebooks/forcing"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#import-libraries">Import libraries</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#user-mods">User mods</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#set-things-for-future-calculations">Set things for future calculations</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#create-vertical-grid">Create vertical grid</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#read-in-data-from-era5-backtrajectory-netcdf">Read in data from ERA5 backtrajectory (netCDF)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#get-geostrophic-wind-forcing">Get Geostrophic wind forcing</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#interpolate-profiles">Interpolate profiles</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#smooth-initial-water-vapor-mixing-ratio-profile">Smooth initial water vapor mixing ratio profile</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#do-surface-forcing">Do surface forcing</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#create-new-netcdf-file">Create new netcdf file</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By ARM Development Team
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>